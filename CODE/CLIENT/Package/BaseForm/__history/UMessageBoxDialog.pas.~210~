unit UMessageBoxDialog;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, UBaseDialogForm,
  System.ImageList, Vcl.ImgList, System.Actions, Vcl.ActnList, Vcl.StdCtrls,
  Vcl.Buttons;

type
  TMessageBoxDialog = class(TBaseDialogForm)
    Image1: TImage;
    Panel_Button: TPanel;
    Label1: TLabel;
  private
    FDlgType: TMsgDlgType;
    FButtons: TMsgDlgButtons;
    { Private declarations }
    procedure iniButton;
  protected
    procedure BeforeFormShow; override;
  public
    property DlgType: TMsgDlgType read FDlgType;
    property Buttons: TMsgDlgButtons read FButtons;
  end;

implementation

uses
  UComvar;

{$R *.dfm}

{ TMessageBoxDialog }

procedure TMessageBoxDialog.BeforeFormShow;
var buttoncount:Integer;
begin
  inherited;
  Self.Caption := ParamList.AsString('@Caption');
  Label1.Caption := ParamList.AsString('@Message');
  FDlgType     := TMsgDlgType(ParamList.AsInteger('@DlgType'));
  case DlgType of
    mtWarning       :Image1.Picture.Icon.Handle:=loadicon(Image1.Picture.Icon.Handle, IDI_ASTERISK);
    mtError         :Image1.Picture.Icon.Handle:=loadicon(Image1.Picture.Icon.Handle, IDI_ERROR);
    mtInformation   :Image1.Picture.Icon.Handle:=loadicon(Image1.Picture.Icon.Handle, IDI_WARNING);
    mtConfirmation  :Image1.Picture.Icon.Handle:=loadicon(Image1.Picture.Icon.Handle, IDI_QUESTION);
    mtCustom        :Image1.Picture.Icon.Handle:=loadicon(Image1.Picture.Icon.Handle, IDI_HAND);
  end;
  FButtons := ParamList.AsValue('@Buttons').AsType<TMsgDlgButtons>;
  buttoncount := 0;
  for var btn in Buttons do Inc(buttoncount);
  for var btn in Buttons do
  begin
    case btn of
      mbYes:
        begin
          with TBitBtn.CreateParented(Panel_Button.Handle) do
          begin
            Parent := Panel_Button;
            Name   := 'btn_'+Ord(mbYes).ToString;
            Tag    := Ord(mbYes);
            Left   := self.Width - buttoncount*(Width+5) - 20;
            Inc(buttoncount,-1);
            Caption := '是';
            ModalResult := mrYes;
          end;
        end;
      mbOK:
        begin
          with TBitBtn.CreateParented(Panel_Button.Handle) do
          begin
            Parent := Panel_Button;
            Name   := 'btn_'+Ord(mbOK).ToString;
            Tag    := Ord(mbOK);
            Left   := self.Width - buttoncount*(Width+5) - 10;
            Inc(buttoncount,-1);
            Caption := '确定';
            ModalResult := mrOk;
          end;
        end;
      mbNo :
        begin
          with TBitBtn.CreateParented(Panel_Button.Handle) do
          begin
            Parent := Panel_Button;
            Name   := 'btn_'+Ord(mbNo).ToString;
            Tag    := Ord(mbNo);
            Left   := self.Width - buttoncount*(Width+5) - 10;
            Inc(buttoncount,-1);
            Caption := '否';
            ModalResult := mrNo;
          end;
        end;
      mbCancel :
        begin
          with TBitBtn.CreateParented(Panel_Button.Handle) do
          begin
            Parent := Panel_Button;
            Name   := 'btn_'+Ord(mbCancel).ToString;
            Tag    := Ord(mbCancel);
            Left   := self.Width - buttoncount*(Width+5) - 10;
            Inc(buttoncount,-1);
            Caption := '取消';
            ModalResult := mrCancel;
          end;
        end;
      TMsgDlgBtn.mbAbort :
        begin
          with TBitBtn.CreateParented(Panel_Button.Handle) do
          begin
            Parent := Panel_Button;
            Name   := 'btn_'+Ord(mbAbort).ToString;
            Tag    := Ord(mbAbort);
            Left   := self.Width - buttoncount*(Width+5) - 10;
            Inc(buttoncount,-1);
            Caption := '退出';
            ModalResult := mrAbort;
          end;
        end;
      TMsgDlgBtn.mbClose :
        begin
          with TBitBtn.CreateParented(Panel_Button.Handle) do
          begin
            Parent := Panel_Button;
            Name   := 'btn_'+Ord(mbClose).ToString;
            Tag    := Ord(mbClose);
            Left   := self.Width - buttoncount*(Width+5) - 10;
            Inc(buttoncount,-1);
            Caption := '关闭';
            ModalResult := mrClose;
          end;
        end;
    end;
  end;
  //根据消息动态调整消息框的宽度和高度
  //动态的调整按钮的位置
  iniButton;
end;

procedure TMessageBoxDialog.iniButton;
var count:Integer;
begin
  count := 0;
  for var i := Panel_Button.ComponentCount-1 downto 0 do
  begin
    if not(Panel_Button.Components[i] is TBitBtn) then Continue;
    (Panel_Button.Components[i] as TBitBtn).Left := self.Width - count*((Panel_Button.Components[i] as TBitBtn).Width + 5) - 10;
    Inc(count);
  end;
end;

initialization
  Goo.Reg.RegisterClass(TMessageBoxDialog)

end.
